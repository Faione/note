kind: ConfigMap
apiVersion: v1
metadata:
  name: prometheus-config
  namespace: gluenet-test1
data:
  prometheus.yml: |
    global:
      scrape_interval:     5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      evaluation_interval: 5s # Evaluate rules every 15 seconds. The default is every 1 minute.
    rule_files:
    - "/prometheus/rules/*.yml"
    scrape_configs:
    remote_write:
    - url: "http://gluenet-transfer-svc:10099/v2/apis/agent/metric/write"
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: prometheus-rules
  namespace: gluenet-test1
data:
  rules.yml: |
    groups:
      # 自定义rule
      # k8s平台下的指标 ，可监控机，容器的cpu memory disk network
      - name: userdefine
        rules:
      # machine cluster-总和 ，前端的判断标志：当host_name: "*" 为总和
        # 1. machine-cpu总和,单位：%
          - expr: |
              sum( clamp_max(clamp_min(1 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[1m]))),0),1) * on (instance) label_replace(machine_cpu_cores{prometheus_replica="prometheus-k8s-0"},"instance","$1","node","(.+)")) * 100 / sum(machine_cpu_cores{prometheus_replica="prometheus-k8s-0"})
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              host_name: "*"
              label: "cluster_cpu_usage"
            record: "metrics"
        # 2. machine-memory总和,单位：%
          - expr: |
              100 - sum(node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes)/sum(node_memory_MemTotal_bytes)*100
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              host_name: "*"
              label: "cluster_memory_usage"
            record: "metrics"
        # 3. machine-disk总和,单位：%
      # machine-总核心和总内存
          - expr: |
              sum by(host_name)(label_replace(machine_cpu_cores, "host_name", "$1", "node", "(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_cpu_cores"
            record: "metrics"
          - expr: |
              sum by(host_name)(label_replace(machine_cpu_physical_cores, "host_name", "$1", "node", "(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_cpu_physical_cores"
            record: "metrics"
          - expr: |
              sum by(host_name)(label_replace(machine_memory_bytes, "host_name", "$1", "node", "(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_memory_bytes"
            record: "metrics"
      # machine-单个
        # 一、cpu相关指标
          # 1.单个主机的cpu利用率 = 100 - ((所有空闲状态CPU使用时间总和 )/(所有状态CPU时间总和))*100  单位：%
          - expr: |
              sum(100 - avg by (host_name)(label_replace(irate(node_cpu_seconds_total{mode="idle"}[15s]),"host_name","$1","instance","(.+)")) * 100)without(instance)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_cpu_usage"
            record: "metrics"
          # 2.cpu处于用户时间的使用率
          - expr: |
              sum by(host_name)((label_replace(irate(node_cpu_seconds_total{mode="user"}[15s]),"host_name","$1","instance","(.+)")) * 100)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_cpu_user_usage"
            record: "metrics"
          # 3.cpu处于系统时间的使用率
          - expr: |
              sum by(host_name)((label_replace(irate(node_cpu_seconds_total{mode="system"}[15s]),"host_name","$1","instance","(.+)")) * 100)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_cpu_system_usage"
            record: "metrics"
        # 二、memory相关指标
          # 1.memory利用率 单位：%
          - expr: |
              100 - (sum by(host_name)(label_replace(((node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes)/node_memory_MemTotal_bytes),"host_name","$1","instance","(.+)")) * 100)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_memory_usage"
            record: "metrics"
          # 2.memory使用量（已经用了多少）单位：byte
          - expr: |
              sum by(host_name)(label_replace(node_memory_MemTotal_bytes-node_memory_MemAvailable_bytes,"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_memory_used"
            record: "metrics"
          # 3.memory剩余量 单位：byte
          - expr: |
              sum by(host_name)(label_replace(node_memory_MemAvailable_bytes,"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_memory_avilable"
            record: "metrics"
        # 三、disk相关指标
          - expr: |
              100 - (sum by(host_name) (label_replace((node_filesystem_free_bytes{mountpoint="/"}/node_filesystem_size_bytes{mountpoint="/"} * 100),"host_name","$1","instance","(.+)")))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_space_usage"
            record: "metrics"
          - expr: |
              sum by(host_name)(label_replace((irate(node_disk_io_time_seconds_total[1m])*100),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_activity_time"
            record: "metrics"
          - expr: |
              sum by (host_name) (label_replace(irate(node_disk_read_bytes_total[1m]),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_read_rate"
            record: "metrics"
          - expr: |
              sum by (host_name) (label_replace(irate(node_disk_written_bytes_total[1m]),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_written_rate"
            record: "metrics"
          - expr: |
              sum by (host_name) (label_replace(irate(node_disk_reads_completed_total[1m]),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_reads_iops"
            record: "metrics"
          - expr: |
              sum by (host_name) (label_replace(irate(node_disk_writes_completed_total[1m]),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_disk_writes_iops"
            record: "metrics"
        # 四、network相关指标
          - expr: |
              sum by(agent_guid,host_name)(label_replace((irate(node_network_receive_bytes_total[1m])*8/1024),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_network_receive_kbps"
            record: "metrics"
          - expr: |
              sum by(agent_guid,host_name)(label_replace((irate(node_network_transmit_bytes_total[1m])*8/1024),"host_name","$1","instance","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "machine"
              agent_guid: "AGENT_GUID"
              label: "node_network_transmit_kbps"
            record: "metrics"
      # apllication 总和，把每个application对应的容器加和（还未添加）
        # 一 .apllication 总和 cpu
          - expr: |
              sum by(application_guid) (label_replace((irate(container_cpu_system_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m])+irate(container_cpu_user_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]))*100,"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              container: "*"
              label: "application_cpu_usage"
            record: "metrics"
          #保留 不作为接口使用
          - expr: |
              sum by(application_guid) (label_replace((container_cpu_usage_seconds_total{container!~"POD|linkerd-proxy",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              container: "*"
              label: "application_cpu_used_seconds"
            record: "metrics"
          - expr: |
              sum by(application_guid) (label_replace((container_memory_working_set_bytes{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              container: "*"
              label: "application_memory_used_bytes_total"
            record: "metrics"
      # container-单个
        # 一 、container单个-cpu相关指标
          - expr: |
              sum by(pod,container,application_guid)(label_replace((irate(container_cpu_system_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m])+irate(container_cpu_user_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]))*100,"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_usage"
            record: "metrics"
          - expr: |
              sum by(pod,container,application_guid)(label_replace(irate(container_cpu_system_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m])*100,"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_system_usage"
            record: "metrics"
          - expr: |
              (sum by(pod,container,application_guid)(label_replace(irate(container_cpu_user_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]),"application_guid","$1","namespace","(.+)")))*100
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_user_usage"
            record: "metrics"
          # 保留但是不用做指标
          - expr: |
              sum by(pod,container,application_guid)(label_replace((container_cpu_system_seconds_total+container_cpu_user_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_used_seconds"
            record: "metrics"
          - expr: |
              sum by(pod,container,application_guid)(label_replace((container_cpu_system_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_system_used_seconds"
            record: "metrics"
          - expr: |
              sum by(pod,container,application_guid)(label_replace((container_cpu_user_seconds_total{container!~"POD|linkerd-proxy|gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_user_used_seconds"
            record: "metrics"
        # 二 、container单个-memory相关指标
          # 1. 容器内存使用量 单位：byte （函数选择上有些问题）
          - expr: |
              sum by(pod,container,application_guid) (label_replace(container_memory_working_set_bytes{container!~"POD|linkerd-proxy||gluenet.*",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"},"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_memory_used"
            record: "metrics"
        # 三、container单个-disk相关指标
          # 1. 容器磁盘写速率 单位：b/s
          - expr: |
              sum by(pod,container,application_guid) (label_replace(irate(container_fs_writes_bytes_total{container!~"POD|linkerd-proxy",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_disk_write_rate"
            record: "metrics"
          # 2. 容器磁盘读速率
          - expr: |
              sum by(pod,container,application_guid) (label_replace(irate(container_fs_reads_bytes_total{container!~"POD|linkerd-proxy",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_disk_read_rate"
            record: "metrics"
          # 四、container-network相关指标
          - expr: |
              sum by(pod,container,application_guid) (label_replace(irate(container_network_receive_bytes_total{container!~"POD|linkerd-proxy",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_network_receive_kbps"
            record: "metrics"
          - expr: |
              sum by(pod,container,application_guid) (label_replace(irate(container_network_transmit_bytes_total{container!~"POD|linkerd-proxy",image!="",namespace!~"default|kube-system|monitoring|linkerd-viz|linkerd|minikube-frpc"}[1m]),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_network_transmit_kbps"
            record: "metrics"
      #状态
          - expr: |
              sum without(pod,uid,namespace,job,instance)(label_replace((0*kube_pod_container_status_waiting{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz|minikube-frpc",container!~"linkerd-proxy"}+1*kube_pod_container_status_ready{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"}+2*kube_pod_container_status_terminated{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"}),"application_guid","$1","namespace","(.+)"))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_status_information"
            record: "status"
          - expr: |
              avg by(application_guid)(sum without(pod,uid,namespace,job,instance)(label_replace((0*kube_pod_container_status_waiting{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz|minikube-frpc",container!~"linkerd-proxy"}+1*kube_pod_container_status_ready{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz|minikube-frpc",container!~"linkerd-proxy"}+2*kube_pod_container_status_terminated{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz|minikube-frpc",container!~"linkerd-proxy"}),"application_guid","$1","namespace","(.+)")))
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              container: "*"
              agent_guid: "AGENT_GUID"
              label: "application_status_information"
            record: "status"
      #其他
          # - expr: |
          #     sum(label_replace(kubelet_node_name,"host_name","$1","node","(.+)")) by (host_name)
          #   labels:
          #     organize: "gluenets"
          #     platform: "kubernetes"
          #     object: "machine"
          #     agent_guid: "AGENT_GUID"
          #     label:  "agent_hosts"
          #   record: "info"
          # - expr: |
          #     sum(label_replace(label_replace((kube_pod_container_info{prometheus_replica="prometheus-k8s-0",namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"}) + on (pod,namespace) group_left(node)(0 * kube_pod_info{prometheus_replica="prometheus-k8s-0",namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz"}),"application_guid","$1","namespace","(.+)"),"host_name","$1","node","(.+)")) without(uid,job,instance,image_id,image_spec,namespace,node)
          #   labels:
          #     organize: "gluenets"
          #     platform: "kubernetes"
          #     object: "application"
          #     agent_guid: "AGENT_GUID"
          #     label: "instance_containers"
          #   record: "info"
          # - expr: |
          #     sum(label_replace((kube_pod_container_info{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"} + on (pod,namespace) group_left(host_name)(0 * label_replace(kube_pod_info{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz"},"host_name","$1","node","(.+)"))),"application_guid","$1","namespace","(.+)")) without(uid,job,instance,image_id,image_spec,namespace)
          #   labels:
          #     organize: "gluenets"
          #     platform: "kubernetes"
          #     object: "machine"
          #     agent_guid: "AGENT_GUID"
          #     label: "agent_containers"
          #   record: "info"
          # - expr: |
          #     sum(label_replace(kube_pod_container_info{container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)"))by(container,application_guid,pod,image,container_id)
          #   labels:
          #     organize: "gluenets"
          #     platform: "kubernetes"
          #     object: "application"
          #     agent_guid: "AGENT_GUID"
          #     label: "container_info"
          #   record: "info"
          - expr: |
              sum(label_replace(kube_pod_container_status_ready{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) without(uid,job,instance,namespace)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_state_ready"
            record: "status"
          - expr: |
              sum(label_replace(kube_pod_container_status_waiting{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) without(uid,job,instance,namespace)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_state_not_ready"
            record: "status"
          - expr: |
              sum(label_replace(kube_pod_container_status_waiting{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) by(application_guid) == 0
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              container: "*"
              label: "application_state_ready"
            record: "status"
          - expr: |
              sum(label_replace(kube_pod_container_status_waiting{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) by(application_guid) > 0
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              container: "*"
              label: "application_state_not_ready"
            record: "status"
          - expr: |
              sum(label_replace(kube_pod_container_resource_limits{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) without (instance,job,uid,namespace,node)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_memory_limits"
            record: "resources"
          - expr: |
              sum(label_replace(kube_pod_container_resource_requests{namespace!~"default|monitoring|kube-system|linkerd|linkerd-viz",container!~"linkerd-proxy"},"application_guid","$1","namespace","(.+)")) without (instance,job,uid,namespace,node)
            labels:
              organize: "gluenets"
              platform: "kubernetes"
              object: "application"
              agent_guid: "AGENT_GUID"
              label: "container_cpu_memory_request"
            record: "resources"
---
apiVersion: v1
kind: Pod
metadata:
  name: glue-stream-prom
  namespace: gluenet-test1
  labels:
    app: glue-stream-prom
spec:
  nodeName: worker1.okd.example.com
  containers:
    - name: prometheus
      image: "prom/prometheus:latest"
      args:
        - --web.enable-remote-write-receiver
        - --web.enable-lifecycle
        - --config.file=/prometheus/config/prometheus.yml
        - --storage.tsdb.path=/prometheus/data/prom
      ports:
        - containerPort: 9090
          name: prometheus
      volumeMounts:
        - mountPath: /prometheus/config/prometheus.yml
          name: prometheus-config
          subPath: prometheus.yml
        - mountPath: /prometheus/rules/rules.yml
          name: prometheus-rules
          subPath: rules.yml
        - mountPath: /prometheus/data/
          name: kubeconfig
  volumes:
    - configMap:
        name: prometheus-config
      name: prometheus-config
    - configMap:
        name: prometheus-rules
      name: prometheus-rules
    - name: kubeconfig
      persistentVolumeClaim:
        claimName: config
---
kind: Service
apiVersion: v1
metadata:
  name: glue-stream-prom-service
  namespace: gluenet-test1
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 10000
      targetPort: 9090
  selector:
    app: glue-stream-prom
---
apiVersion: v1
kind: Pod
metadata:
  name: gluenet-transfer
  labels:
    app.kubernetes.io/component: gluenet-transfer
    app.kubernetes.io/name: gluenet-transfer
    app.kubernetes.io/part-of: kube-prometheus
    app: gluenet-transfer
  namespace: gluenet-test1
spec:
  containers:
    - name: glue-transfer
      image: gluenet/transfer:0.1
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 10099
      env:
        - name: RPC_CONFIG
          value: "nats://39.101.140.145:4222"
        - name: PUSH_TOPIC
          value: "guid.manager:rpc.apis.data.metrics.push"
---
apiVersion: v1
kind: Service
metadata:
  name: gluenet-transfer-svc
  namespace: gluenet-test1
spec:
  type: ClusterIP
  ports:
  - name: gluenet-transfer
    protocol: TCP
    port: 10099
    targetPort: 10099
  selector:
    app: gluenet-transfer
---
kind: Service
apiVersion: v1
metadata:
  name: glue-stream-prom-frontend
  namespace: gluenet-test1
spec:
  type: NodePort
  ports:
    - name: http
      port: 55555
      targetPort: 9090
  selector:
    app: glue-stream-prom