## 基于Prometheus的Cilium监控

### 环境准备

- 安装脚本
  - `--set hubble.metrics.enabled=""` 来关闭metric
  - `--reuse-values`可以复用已有的value, 搭配`helm upgrade`已避免覆盖先前配置
  - `HUBBLE_METRIC_CONFIG`用来设置需要从hubble中获取的监控指标以及其配置
    - [hubble监控设置](https://docs.cilium.io/en/stable/operations/metrics/)

**更改现有配置**

```shell
RELEASE="cilium"
CHART="cilium/cilium"
VERSION="1.12.1"
NAMESPACE="kube-system"

# HUBBLE_METRIC_CONFIG="{flow:destinationContext=pod;namespace;sourceContext=pod;namespace,http:destinationContext=pod;namespace;sourceContext=pod;namespace}"
HUBBLE_METRIC_CONFIG="{flow:destinationContext=identity;pod;namespace;sourceContext=identity;pod;namespace,http:destinationContext=identity;pod;namespace;sourceContext=identity;pod;namespace}"

helm upgrade $RELEASE $CHART --version $VERSION \
  --namespace $NAMESPACE \
  --reuse-values \
  --set hubble.relay.enabled=true \
  --set hubble.metrics.enabled=$HUBBLE_METRIC_CONFIG \

  # --set hubble.ui.enabled=true

helm upgrade $RELEASE $CHART --version $VERSION \
  --namespace $NAMESPACE \
  --reuse-values \
  --set hubble.ui.enabled=true
```

**从零开始**

```shell
REPO_NAME="https://helm.cilium.io/"
REPO_URL="https://helm.cilium.io/"

RELEASE="cilium"
CHART="cilium/cilium"
VERSION="1.12.1"
NAMESPACE="kube-system"

HUBBLE_METRIC_CONFIG="{flow:destinationContext=pod;namespace;sourceContext=pod;namespace,http:destinationContext=pod;namespace;sourceContext=pod;namespace}"


helm repo add $REPO_NAME $REPO_URL

helm install $RELEASE $CHART --version $VERSION \
  --namespace $NAMESPACE \
  --set hubble.relay.enabled=true \
  --set hubble.metrics.enabled=$HUBBLE_METRIC_CONFIG \
```

**Prometheus设置**

需要在prometheus中删除过滤配置(注释一个config), 从而启动其他pod的监控 
- [slim-prometheus](./prometheus/prometheus.yaml)

```yaml
# promethues.yaml origin from (https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml)

scrape_configs:
  - job_name: 'kubernetes-endpoints'
    scrape_interval: 30s
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)(?::\d+);(\d+)
        replacement: $1:$2
```

部署prometheus

```shell
$ kubectl apply -f <slim-prometheus-yaml>
```

查看prometheus

```shell
$ kubectl -n cilium-monitoring port-forward service/prometheus --address 0.0.0.0 --address :: 3000:9090
```

### 监控方案设计

#### 监控配置

hubble meric配置`flow:destinationContext=pod;namespace;sourceContext=pod;namespace`，使得每一条flow的metric，都会按`namespace/podname`的格式，增加`destination` 与 `source` label，即这条流产生的源节点与目的节点，通过这些信息，能够不断聚合得到关系图谱
- `protocol`标识了flow的协议, 如HTTP,TCP,UDP等
- `verdict`标识了cilium对flow的处理，DROPPED表示丢弃，FORWARDED表示让行
- `type`标识了flow的层级

#### 监控指标

hubble_flows_processed_total

```
hubble_flows_processed_total{app_kubernetes_io_managed_by="Helm",destination="default/deathstar-6c94dcc57b-2chb9",instance="192.168.50.139:9965",job="kubernetes-endpoints",k8s_app="hubble",namespace="kube-system",protocol="HTTP",service="hubble-metrics",source="default/tiefighter",subtype="HTTP",type="L7",verdict="DROPPED"} : 2
```

hubble_http_requests_total

```
hubble_http_requests_total{app_kubernetes_io_managed_by="Helm",destination="default/deathstar-6c94dcc57b-2chb9",instance="192.168.50.139:9965",job="kubernetes-endpoints",k8s_app="hubble",method="POST",namespace="kube-system",protocol="HTTP/1.1",service="hubble-metrics",source="default/tiefighter"} : 1
```
hubble_http_responses_total

```
hubble_http_responses_total{app_kubernetes_io_managed_by="Helm",destination="default/tiefighter",instance="192.168.50.139:9965",job="kubernetes-endpoints",k8s_app="hubble",method="POST",namespace="kube-system",service="hubble-metrics",source="default/deathstar-6c94dcc57b-2chb9",status="200"} : 4
```

#### 数据结构

hubble ui 数据结构(生成Map)

```
# HubbleLink(edge)
[
  {
    id: 'reserved:world:outgoing',
    sourceId: 'reserved:world:outgoing',
    destinationId: 'a8de92d55119c9a6bb6a6dd66bcf012fabefb32d',
    destinationPort: 443,
    ipProtocol: IPProtocol.TCP,
    verdict: Verdict.Forwarded,
  },
  ...
]

# HubbleService(node)
[
  {
    id: 'reserved:world:outgoing',
    name: 'World',
    namespace: selectedNamespace,
    labels: [{ key: 'reserved:world', value: '' }],
    dnsNames: [],
    egressPolicyEnforced: false,
    ingressPolicyEnforced: false,
    visibilityPolicyStatus: '?unknown?',
    creationTimestamp: dataHelpers.msToPbTimestamp(Date.now()),
  },
  ...
]
```



#### 流处理过程

