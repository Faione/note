## Overlay网络控制

服务级: 基于身份在软件层面对实体服务进行组网
- 哪些服务能够相互访问
应用级别: 基于身份在接口层面对实体接口进行组网
- 哪些服务能够访问哪些服务的哪些接口
### 对等实体组网

基于身份组网

**网络隔离**

- 同一group的实体相互访问
- 不同group的实体不能访问

**网络组网**

- 新增实体通过增加身份加入group

### 应用级

**请求隔离**

- L7级，非对等组网




# group隔离实验 


## 基于标签组网

**label**:
- `gluenet_id`: guid
- `gluenet_net_role`: A\B\C\D

| role  |     Ingress      |      Egress      |             描述             |
| :---: | :--------------: | :--------------: | :--------------------------: |
|   A   | 同一`gluenet_id` | 同一`gluenet_id` |           内部服务           |
|   B   | 同一`gluenet_id` |      无限制      | 有访问外部服务需求的内部服务 |
|   C   |      无限制      | 同一`gluenet_id` |           公共服务           |
|   D   |      无限制      |      无限制      |         级联公共服务         |

### Demo

#### 网络规则


```yaml
# 角色规则 A
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "gluenet_base_rule_A"
  namespace: guid
spec:
  endpointSelector:
    matchLabels:
      gluenet_id: ${metadata.namespace}
      role: A
  ingress:
  - fromEndpoints:
    - matchLabels:
      gluenet_id: ${metadata.namespace}
  egress:
  - fromEndpoints:
    - matchLabels:
      gluenet_id: ${metadata.namespace} 
---
# 角色规则 B
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "gluenet_base_rule_B"
  namespace: guid
spec:
  endpointSelector:
    matchLabels:
      gluenet_id: ${metadata.namespace}
      role: B
  ingress:
  - fromEndpoints:
    - matchLabels:
      gluenet_id: ${metadata.namespace}
  egress:
  - toEndpoints:
    - {}
---
# 角色规则 C
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "gluenet_base_rule_C"
  namespace: guid
spec:
  endpointSelector:
    matchLabels:
      gluenet_id: ${metadata.namespace}
      role: C
  ingress:
  - fromEndpoints:
    - {}
  egress:
  - fromEndpoints:
    - matchLabels:
      gluenet_id: ${metadata.namespace} 
---
# 角色规则 D
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "gluenet_base_rule_D"
  namespace: guid
spec:
  endpointSelector:
    matchLabels:
      gluenet_id: ${metadata.namespace}
      role: D
  ingress:
  - fromEndpoints:
    - {}
  egress:
  - toEndpoints:
    - {}
```

#### 端点配置

|    guid     |    pod     | network |
| :---------: | :--------: | :-----: |
| test-guid-1 | deathstar  |    A    |
| test-guid-1 | tiefighter |    A    |
| test-guid-1 |   xwing    |    B    |
| test-guid-2 | deathstar  |    C    |
| test-guid-2 | tiefighter |    A    |
| test-guid-2 |   xwing    |    D    |


**app1**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: test-guid-1
---
apiVersion: v1
kind: Service
metadata:
  name: deathstar
  namespace: test-guid-1
  labels:
    app: deathstar
spec:
  type: ClusterIP
  ports:
  - port: 80
  selector:
    app: deathstar
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deathstar
  namespace: test-guid-1
  labels:
    app: deathstar
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deathstar
  template:
    metadata:
      labels:
        app: deathstar
        gluenet_id: ${metadata.namespace}
        role: A
    spec:
      containers:
      - name: deathstar
        image: docker.io/cilium/starwars
---
apiVersion: v1
kind: Pod
metadata:
  name: tiefighter
  namespace: test-guid-1
  labels:
    gluenet_id: ${metadata.namespace}
    role: A
spec:
  containers:
  - name: spaceship
    image: docker.io/tgraf/netperf
---
apiVersion: v1
kind: Pod
metadata:
  name: xwing
  namespace: test-guid-1
  labels:
    gluenet_id: ${metadata.namespace}
    role: B
spec:
  containers:
  - name: spaceship
    image: docker.io/tgraf/netperf
```

**app2**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: test-guid-2
---
apiVersion: v1
kind: Service
metadata:
  name: deathstar
  namespace: test-guid-2
  labels:
    app: deathstar
spec:
  type: ClusterIP
  ports:
  - port: 80
  selector:
    app: deathstar
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deathstar
  namespace: test-guid-2
  labels:
    app: deathstar
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deathstar
  template:
    metadata:
      labels:
        app: deathstar
        gluenet_id: ${metadata.namespace}
        role: C
    spec:
      containers:
      - name: deathstar
        image: docker.io/cilium/starwars
---
apiVersion: v1
kind: Pod
metadata:
  name: tiefighter
  namespace: test-guid-2
  labels:
    gluenet_id: ${metadata.namespace}
    role: A
spec:
  containers:
  - name: spaceship
    image: docker.io/tgraf/netperf
---
apiVersion: v1
kind: Pod
metadata:
  name: xwing
  namespace: test-guid-2
  labels:
    gluenet_id: ${metadata.namespace}
    role: D
spec:
  containers:
  - name: spaceship
    image: docker.io/tgraf/netperf
```