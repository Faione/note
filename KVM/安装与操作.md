

- [kvm git book](http://ksoong.org/docs/content/linux/rhel/kvm.html)


## 安装

- 安装`libvirt`的同时，也会安装`virsh`

```shell
$ yum install qemu-kvm libvirt 
```

- 安装虚拟机安装工具

```shell
$ yum install virt-install
```

- 启动

```shell
# 开机启动
$ systemctl enable libvirtd

# 启动
$ systemctl start libvirtd

# 查看状态
$ systemctl status libvirtd
```

## 创建虚拟机

- centos中安装ubuntu存在问题
  - `无法为 Ubuntu 树找到 hvm 内核`

```shell
# 在当前目录创建磁盘
$ qemu-img create -f qcow2 vm 10G

# 安装虚拟机

# bridge
$ virt-install \
  --connect qemu:///system \
  --virt-type kvm \
  --name centos7 \
  --vcpus 2 --memory 1024 \
  --disk path=/home/fhl/virtualmachines/centos7/vm,size=10,format=qcow2 \
  --location  /home/fhl/Download/os_image/CentOS-7-x86_64-Minimal-2009.iso \
  --network bridge=virbr0 \
  --graphics none \
  --extra-args console=ttyS0 \
  --debug

# nat
$ virt-install \
  --connect qemu:///system \
  --virt-type kvm \
  --name centos7 \
  --vcpus 2 --memory 1024 \
  --disk path=/home/fhl/virtualmachines/centos7/vm,size=10,format=qcow2 \
  --location  /home/fhl/Download/os_image/CentOS-7-x86_64-Minimal-2009.iso \
  --network network=default \
  --graphics none \
  --extra-args console=ttyS0 \
  --debug

# ubuntu
$ virt-install \
  --connect qemu:///system \
  --virt-type kvm \
  --name gluenet-ubuntu-01 \
  --vcpus 2 --memory 2048 \
  --disk path=/home/fhl/virtualmachines/gluenets/ubuntu-01/vm,size=10,format=qcow2 \
  --cdrom  /home/fhl/Download/os_image/ubuntu-22.04-live-server-amd64.iso \
  --network network=default \
  --vnc --vncport=5911 \
  --debug
```

### nat网络配置

```shell
# 连接虚拟机
$ virsh console <virtualmachine>
```

- 查看网络配置

```shell
$ virsh net-edit default
```

- 配置虚拟机网络

```shell
$ vim /etc/sysconfig/network-scripts/{nic}

IPADDR=192.168.122.10
NETMASK=255.255.255.0
GATEWAY=192.168.122.1
DNS1=8.8.8.8
```


## 删除虚拟机

```shell
# 关闭虚拟机
$ virsh shutdown ubuntu-22.04

# 无法关闭，则可以直接删除虚拟机
$ virsh destroy ubuntu-22.04

# 查看快照
$ virsh snapshot-list --domain ubuntu-22.04

# 删除快照
$ virsh snapshot-delete --domain vm-name --snapshotname 3sep2016u1

# 取消虚拟机
$ virsh undefine ubuntu-22.04
```

## 脚本

- [Ubuntu](https://gist.github.com/xavierlineX/16d523dd13a561fc790e8232a3944bd9)

```shell
#!/bin/bash
# file: bless.sh, +x

VM_NAME=gluenet-ubuntu
# 4096MB Memory
MEM_SIZE=4096
CPU_NUM=2
VNC_PORT=5905
# Some vnc clients require a password
VNC_PASSWORD=123456
CDISO="$HOME/Download/os_image/ubuntu-22.04-live-server-amd64.iso"
# ubuntu 22.04 not in list, so use ubuntu 20.04.
OSTYPE=ubuntu20.04
# 20GB disk size
DISKSIZE=15

sudo whoami
# next we create a virtual machine with legacy BIOS firmware
# if want to use UEFI, install OVMF and append `--boot uefi` in following command:
sudo virt-install --name $VM_NAME \
--virt-type kvm --memory $MEM_SIZE --vcpus $CPU_NUM \
--graphics vnc,port=$VNC_PORT,password=$VNC_PASSWORD \
--cdrom $CDISO \
--network network=default \
--os-variant $OSTYPE \
--disk path="$HOME/vms/${VM_NAME}.raw",size=$DISKSIZE,bus=virtio,format=raw
```

