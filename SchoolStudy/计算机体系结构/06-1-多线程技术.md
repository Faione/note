# 多线程技术

- [多线程技术](#多线程技术)
  - [一、多发射处理器局限](#一多发射处理器局限)
  - [二、多线程技术基本思想](#二多线程技术基本思想)
    - [(1) 简单多线程流水线](#1-简单多线程流水线)
    - [(2) 多线程开销](#2-多线程开销)
    - [(3) 线程调度方式](#3-线程调度方式)
  - [三、多线程处理器分类](#三多线程处理器分类)
    - [(1) Coarse-Grained MT](#1-coarse-grained-mt)
    - [(2) Fine-Grained MT](#2-fine-grained-mt)
    - [(3) Simultaneous Multithreading](#3-simultaneous-multithreading)

## 一、多发射处理器局限

- 工作负载可以使用线程级并行来完成(TLP)
  - 多任务 TLP (运行相互的独立的任务)
  - 多线程 TLP (使用多线程来加速一个任务的运行)

- 基本思想: 使用TLP来提高单个处理器的利用率
  - *多个线程以重叠的方式共享单个处理器的功能单元*
  - 增加相应的功能部件以实现处理器功能单元的共享
    - PC, regs

## 二、多线程技术基本思想

- 解决一条流水线上的指令之间的数据依赖关系
  - 在相同的流水线中交叉指向来自不同线程的指令

### (1) 简单多线程流水线

- 必须传递线程选择信号以保证各流水段读写的正确性
- 给外部存在多个CPU的假象
  - 对每个线程而言，执行速度相对变慢

### (2) 多线程开销

- 每个线程需要拥有自己的用户态
  - PC
  - GPRs
- 每个线程需要自己的系统态信息
  - 虚拟内存的页表基地址寄存器
  - 异常处理器
- 其他开销
  - 线程冲突导致的Cache/TLB冲突
  - 管理更多线程导致的OS调度开销

### (3) 线程调度方式

- 固定交叉模式
  - 对于N个线程，每条线程每隔N个周期执行一条指令
    - 每个线程分配固定的时隙
  - 流水线某一时隙对应线程未就绪，则插入pipline bubble
    - 潜在地消除旁路和互锁逻辑
- 软件控制的交叉模式
  - OS为N个线程分配流水线的S个流水线时隙
    - 每个线程的时隙可以不同，但仍然是周期性地执行
    - 如线程 A 每隔 1 个流水线周期执行一次，B每隔3个流水周期执行一次
    - 依据Priority差异
  - 硬件对于S个时隙采用固定交叉模式执行相应的线程
- 硬件控制的线程调度
  - 硬件跟踪处于ready状态的线程
  - 根据优先级方案选择线程执行
    - 不再是周期性的执行，而是切换式地执行
    - A执行n个周期，B紧接着执行m个周期

## 三、多线程处理器分类

- Chip Multiprocessing (CMP)
  - 同一时钟周期可以运行不同线程的指令
    - **单个处理器核心同一时钟周期无法执行不同线程的指令**
  - 从单个核心来看，没有减少水平浪费和垂直浪费
    - 但由于发射宽度在核间进行了静态分配，使得水平和垂直方向的浪费减少

### (1) Coarse-Grained MT

> 粗粒度多线程

- 基本策略
  - 当线程运行时**存在较长时间延时**时，切换到另一线程
    - 如 cache失效、线程等待同步结束
- 评价
  - 减少了垂直方向的浪费，但仍然存在水平方向上的浪费
- 无法应对存在很多stall的线程

### (2) Fine-Grained MT

> 细粒度多线程

- 多个线程的指令交叉执行
  - 线程的切换频率高、周期短
- 评价
  - 能够减少垂直方向的浪费
    - 线程数足够多时，可以消除垂直方向的浪费
  - 仍然存在水平方向的浪费
- FMT与CMT
  - FMT每个周期在线程之间进行上下文切换，能够让线程连续执行
  - CMT每隔几个周期在线程之间进行一次上下文切换，能够隐藏较长的stall


### (3) Simultaneous Multithreading

> 同步多线程