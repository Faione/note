# 中断与异常

## 一、基本概念

**中断**

- 可屏蔽中断
  - I/O设备产生的所有中断请求（IRQ）都产生可屏蔽中断
  - 根据中断允许标志的设置来判断CPU是否能响应中断请求
- 非屏蔽中断
  - 只有几个危急时间（如硬件故障）才引起非屏蔽中断
  - 不受中断允许标志的影响，不能用软件进行屏蔽
- 三种主要中断
  - I/O中断、时钟中断、处理器间中断

**异常**

- 处理器探测异常
  - 故障（fault）
  - 陷阱（trap）
  - 异常中止（abort)
- 编程异常

- 每个中断和异常是由0～255之间的一个数来标识
  - Intel把这个8位无符号整数称为一个向量
- 中断标识
  - 非屏蔽中断和异常的标识是固定的
  - 而可屏蔽中断的标识可通过对中断控制器的编程来改变

### (1) IRQ和中断

- 每一个能够发出中断请求的硬件设备控制器都有一条名为`IRQ(Interrupt ReQuest)`的输出线
- 所有现有的IRQ line都与一个名为可编程中断控制器（Programmable Interrupt Controller. PIC）的硬件电路的输入引脚相连，可编程中断控制器执行下列动作：
  - 监视IRQ线，检查产生的信号
  - 如果一个引发信号出现在IRQ line上
    - 把接收的引发信号转换为对应的向量
    - 把这个向量存放在中断控制器的一个I/O端口，从而允许CPU通过数据总线读取此向量
    - 把引发信号发送到处理器的INTR引脚，即产生一个中断
    - 等待，直到CPU通过把这个中断信号写进可编程中断控制器的一个I/O端口来确认
      - 当这种情况发生时, 清INTR线
  - 返回继续监视IRQ line
- IRQ line从0开始顺序编号，因此第一条IRQ line通常表示$IRQ_{0}$
  - 与$IRQ_{n}$关联的Intel缺省向量为n+32
  - 通过向中断控制器端口发布合适的指令，就可以修改IRQ和向量之间的映射

**高级可编程中断控制器**

- 单处理器系统设计的PIC，主PIC输出线直接连接CPU的INTR引脚
- 两个或多个CPU需要更为复杂的PIC
  - 并行化SMP体系结构，中断需要传递给系统的每一个CPU
  - 引入I/O Advanced Programmable Interrupt Controller, I/O APIC
  - 来自外部硬件设备的中断请求以两种方式在可用CPU之间进行分发
    - 静态分发
    - 动态分发

### (2) 异常

- 80x86微处理器发布了大约20种不同的异常
  - 内核必须为每种异常提供一个专门的异常处理程序
- CPU控制单元在开始执行异常处理程序前产生一个硬件出错码，并压入内核态堆栈
- 20～31值保留Intel未来开发。
- 相对应的每一个异常由专门的异常处理程序来处理，通常把一个Unix信号发送到引起异常进程

### (3) 中断描述符表

- Interrupt Descriptor Table, IDT
  - 与每一个中断或异常向量相联系，每一个向量在表中有相应的中断或异常处理程序的入口地址
    - 内核在允许中断发生前，必须适当地初始化IDT
  - 每一个向量由8字节组成
    - 需要256×8=2048字节来存放IDT
  - idtr CPU寄存器使IDT可以位于内存的任何位置，指定IDT的线性基地址及其限址（最大长度
  - 在允许中断之前，必须用lidt汇编指令初始化idtr

**描述符类型**

- 任务门
  - 当中断信号发生时，必须取代当前进程的那个进程的TSS选择符存放在任务门中
- 中断门
  - 包含段选择符和中断或异常处理程序的段内偏移量
  - 当控制权转移到一个适当的段时，处理器清IF标志，从而关闭将来可能会发生的可屏蔽中断
- 陷阱门
  - 与中断门相似，只是控制权传递到一个适当的段时处理器不修改IF标志
- Linux利用中断门处理中断，利用陷阱门处理异常