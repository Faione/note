# kubevirt基础操作

## 安装虚拟机

- [kubevirt教程](https://developer.aliyun.com/article/888553)

- `vm-demo.yaml`

```yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachine
metadata:
  labels:
    kubevirt.io/vm: vm-cirros
  name: vm-cirros
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/vm: vm-cirros
    spec:
      domain:
        devices:
          disks:
          - disk:
              bus: virtio
            name: containerdisk
          - disk:
              bus: virtio
            name: cloudinitdisk
        machine:
          type: ""
        resources:
          requests:
            memory: 64M
      terminationGracePeriodSeconds: 0
      volumes:
      - name: containerdisk
        containerDisk:
          image: kubevirt/cirros-container-disk-demo:latest
      - cloudInitNoCloud:
          userDataBase64: IyEvYmluL3NoCgplY2hvICdwcmludGVkIGZyb20gY2xvdWQtaW5pdCB1c2VyZGF0YScK
        name: cloudinitdisk
```

```shell
# 部署虚拟机资源
$ kubectl apply -f vm-demo.yaml

# 运行虚拟机实例
$ virtctl start vm-cirrors

# 连接虚拟机实例
$ virtctl console vm-cirrors
```

### 问题

**节点无法被调度**

- `ErrScheduling`
  - minikube集群搭建在kvm虚拟机之上，因此回产生嵌套虚拟化问题，如果主机不支持嵌套虚拟化，则会出现无法调度的问题

- 开启kubevirt模拟器
  - [tutorial](https://kubevirt.io/user-guide/operations/installation/#requirements)

```shell
$ kubectl edit -n kubevirt kubevirt kubevirt

spec:
    ...
    configuration:
    developerConfiguration:
        useEmulation: true
```

**网络问题**

- `failed plugging phase1 at nic 'eth0'`
- `kubevirt Couldn't configure ip nat rules`
