# More for MMIO

## CPU、总线、内存、以及各种各样的设备是如何进行统筹的？

> 2018: 主流商业处理器面向中高端领域的处理器普遍采用两片结构，而面向中低端及嵌入式领域的处理器普遍采用单片结构 

`CPU-南桥` 两片结构:
- CPU中包含了MMU与GPU, 透过CPU总线与南桥相连
- 南桥中则包括SATA、USB、PCIE、GMAC、HDA等总线接口，并连接BOOT ROM

`SoC` (System on Chip8)单片结构:
- 单个芯片上集成了处理器、内存控制器、GPU以及硬盘、USB、网络等IO接口，用户搭建系统仅需要单个主要芯片

通常而言，总线都会有对应的控制器进行管理

### 内存总线

CPU通过内存总线与内存相连，而在CPU中对总线内存的控制是通过内存控制器实现的。内存控制器负责管理内存条的初始化、读写、以及低功耗控制等操作。内存控制器接受处理器发出的读写命令，将其转化为内存芯片可以识别的DRAM操作(读写、刷新、预充电等)，并负责处理时序相关的问题，最终返回数据(读命令)或者返回一个响应(对于写命令)给处理器。内存控制器一般还包括命令调度功能，以提高内存总线的访问效率。而对于处理器来说，只需要发送读写命令给内存控制器即可

### 系统总线

系统总线通常用于处理器和桥片的连接，同时也作为多处理器间的连接以构成多路系统

> 英特尔处理器广泛采用的 QPI (Quick Path Interconnect) 及在 QPI 之前的 FSB(Front Side Bus), 还有 AMD 处理器所广泛采用的 HT (HyperTransport) 接口都属于系统总线

### 设备总线

> 2022: 当前PCIE总线用途比较宽泛，即存在直连CPU的PCIE(高速，如对GPU)，也有通过南桥汇总(网卡等)，根据处理器的不同设计，会有不同的方案

设备总线用于与IO设备的连接，如PCI(Peripheral Component Interconnect)、PCIE

### 分析

处理器与其他芯片/设备建立联系的方式是总线，而总线除物理上用于连接的部分外，还包括接口，即通信的规范，对应于处理器中的MMU,PCIE控制器等。实际对上层应用而言，处理器屏蔽了控制器的细节，使得软件开发者不必关系控制器的具体实现，而将重心放置在如何按照设备手册来对设备进行操作，如读写MMIO, 软件开发者可以透明的认为修改物理地址即可以修改对应设备上的寄存器。

## 处理器的MMIO地址访存过程是什么样的？

处理器中？物理地址本身编址方式就可能涉及到总线的选择, 应此根据MMU最终生成的物理地址，来决定数据会发送到那一个总线上

## MMIO是否会导致实际内存因没有得到地址映射而被浪费？

可能出现这种情况，在统一物理内存编址的情况下, 内存与其他设备无异，此时物理地址的含义已经被推广，而设备MMIO显然会占用一部分的物理地址空间， `MMIO` + `内存` 大小要大于整个寻址空间的话，那么必然有一部分内存因没有地址可分配而被浪费

相反则最终得到的物理地址空间会由于有MMIO而超过内存大小，在这种情况下，MMIO不会影响实际内存，但需要区分的是，如操作系统为硬件分配了buffer用于数据交换，那么在这种情况下，硬件会占用一定的内存



