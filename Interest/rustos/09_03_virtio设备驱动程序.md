# virtio设备驱动程序

virtio 协议是对hypervisor 中的一组通用模拟设备的抽象，即virtio协议定义了虚拟设备的输入/输出接口。而基于virtio协议的I/O设备称为virtio设备

![](./img/2023-03-09-10-08-54.png)

虚拟机模拟外设的传统方案中，如果guest VM 要使用底层 host主机的资源，需要 Hypervisor 截获所有的I/O请求指令，然后模拟出这些I/O指令的行为，这会带来较大的性能开销

virtio方案中，模拟的外设实现了功能最小化，即虚拟外设的数据面接口主要是与guest VM 共享的内存、控制面接口主要基于内存映射的寄存器和中断机制。这样guest VM 通过访问虚拟外设来使用底层 host主机的资源时，Hypervisor只需对少数寄存器访问和中断机制进行处理，实现了高效的I/O虚拟化过程

数据面（Data Plane）
- 设备与处理器之间的I/O数据传输相关的数据设定（地址、布局等）与传输方式（基于内存或寄存器等）

控制平面（Control Plane）
- 处理器发现设备、配置设备、管理设备等相关的操作，以及处理器和设备之间的相互通知机制

另外，各种类型的virtio设备，如块设备（virtio-blk）、网络设备（virtio-net）、键盘鼠标类设备（virtio-input）、显示设备（virtio-gpu）具有共性特征和独有特征。对于共性特征，virtio设计了各种类型设备的统一抽象接口，而对于独有特征，virtio尽量最小化各种类型设备的独有抽象接口。这样，virtio就形成了一套通用框架和标准接口（协议）来屏蔽各种hypervisor的差异性，实现了guest VM和不同hypervisor之间的交互过程

![](./img/2023-03-09-11-38-41.png)

从本质上讲，virtio是一个接口，允许运行在虚拟机上的操作系统和应用软件通过访问 virtio 设备使用其主机的设备。这些 virtio 设备具备功能最小化的特征，Guest VM中的设备驱动程序(Front-end drivers)只需实现基本的发送和接收I/O数据即可，而位于Hypervisor中的Back-end drivers和设备模拟部分让主机处理其实际物理硬件设备上的大部分设置、维护和处理。这种设计方案极大减轻了virtio驱动程序的复杂性

## virtio架构

总体上看，virtio 架构可以分为上中下三层

上层包括运行在QEMU模拟器上的前端操作系统中各种驱动程序（Front-end drivers）

中间层是传输（transport）层，就是驱动程序与虚拟设备之间的交互接口，包含两部分：
  - 上半部是virtio接口定义，即I/O数据传输机制的定义：virtio 虚拟队列（virtqueue）
  - 下半部是virtio接口实现，即I/O数据传输机制的具体实现：virtio-ring，主要由环形缓冲区和相关操作组成，用于保存驱动程序和虚拟设备之间进行命令和数据交互的信息

下层是在QEMU中模拟的各种虚拟设备 Device

![](./img/2023-03-09-11-42-56.png)

操作系统中virtio 驱动程序的主要功能包括：
1. 接受来自用户进程或操作系统其它组件发出的 I/O 请求
2. 将这些 I/O 请求通过virqueue发送到相应的 virtio 设备
3. 通过中断或轮询等方式查找并处理相应设备完成的I/O请求

Qemu或Hypervisor中virtio设备的主要功能包括：
1. 通过virqueue接受来自相应virtio驱动程序的 I/O 请求
2. 通过设备仿真模拟或将I/O操作卸载到主机的物理硬件来处理I/O请求，使处理后的I/O数据可供virtio驱动程序使用
3. 通过寄存器、内存映射或中断等方式通知virtio驱动程序处理已完成的I/O请求

![](./img/2023-03-09-11-46-45.png)

## I/O设备基本组成结构

virtio设备代表了一类I/O通用设备，为了让设备驱动能够管理和使用设备。在程序员的眼里，I/O设备基本组成结构包括如下：
- 呈现模式：设备一般通过寄存器、内存或特定I/O指令等方式让设备驱动能看到和访问到设备
- 特征描述：让设备驱动能够了解设备的静态特性（可通过软件修改），从而决定是否或如何使用该设备
- 状态表示：让设备驱动能够了解设备的当前动态状态，从而确定如何进行设备管理或I/O数据传输
- 交互机制：交互包括事件通知和数据传输
  - 对于事件通知，让设备驱动及时获知设备的状态变化的机制（可基于中断等机制），以及让设备及时获得设备驱动发出的I/O请求（可基于寄存器读写等机制）
  - 对于数据传输，让设备驱动能处理设备给出的数据，以及让设备能处理设备驱动给出的数据，如（可基于DMA或virtqueue等机制）

## virtio设备基本组成要素

virtio设备的基本组成要素如下：
- 设备配置空间（Device Configuration space）
- 特征位（Feature bits）
- 设备状态域（Device status field）
- 通知（Notifications）
- 一个或多个虚拟队列（virtqueue）

其中的设备特征位和设备配置空间属于virtio设备的特征描述

设备状态域属于virtio设备初始化时的状态表示

通知和虚拟队列属于virtio设备的交互机制，也包含virtio设备运行时的状态表示

## virtio设备呈现模式

virtio设备支持三种设备呈现模式：
- Virtio Over MMIO，虚拟设备直接挂载到系统总线上
- Virtio Over PCI BUS，遵循PCI规范，挂在到PCI总线上，作为virtio-pci设备呈现，在QEMU虚拟的x86计算机上采用的是这种模式
- Virtio Over Channel I/O：主要用在虚拟IBM s390计算机上，virtio-ccw使用这种基于channel I/O的机制。

在Qemu模拟的RISC-V计算机 – virt 上，采用的是Virtio Over MMIO的呈现模式。这样在实现设备驱动时，只需要找到相应virtio设备的I/O寄存器等以内存形式呈现的地址空间，就可以对I/O设备进行初始化和管理了

## virtio设备特征描述

virtio设备特征描述包括设备特征位和设备配置空间

### 特征位

特征位用于表示VirtIO设备具有的各种特性和功能
- bit00 – 23是特定设备可以使用的feature bits
- bit24 – 37预给队列和feature协商机制
- bit38以上保留给未来其他用途
  
驱动程序与设备对设备特性进行协商，形成一致的共识，这样才能正确的管理设备

### 设备配置空间

设备配置空间通常用于配置不常变动的设备参数（属性），或者初始化阶段需要设置的设备参数。设备的特征位中包含表示配置空间是否存在的bit位，并可通过在特征位的末尾添加新的bit位来扩展配置空间。

设备驱动程序在初始化virtio设备时，需要根据virtio设备的特征位和配置空间来了解设备的特征，并对设备进行初始化

## virtio设备状态表示

virtio设备状态表示包括在设备初始化过程中用到的设备状态域，以及在设备进行I/O传输过程中用到的I/O数据访问状态信息和I/O完成情况等

### 设备状态域

设备状态域包含对设备初始化过程中virtio设备的6种状态：
- ACKNOWLEDGE（1）：驱动程序发现了这个设备，并且认为这是一个有效的virtio设备
- DRIVER (2) : 驱动程序知道该如何驱动这个设备
- FAILED (128) : 由于某种错误原因，驱动程序无法正常驱动这个设备
- FEATURES_OK (8) : 驱动程序认识设备的特征，并且与设备就设备特征协商达成一致
- DRIVER_OK (4) : 驱动程序加载完成，设备可以正常工作了
- DEVICE_NEEDS_RESET (64) ：设备触发了错误，需要重置才能继续工作

在设备驱动程序对virtio设备初始化的过程中，需要经历一系列的初始化阶段，这些阶段对应着设备状态域的不同状态

### I/O传输状态

设备驱动程序控制virtio设备进行I/O传输过程中，会经历一系列过程和执行状态，包括 *I/O请求*状态、 *I/O处理*状态、 *I/O完成*状态、 *I/O错误*状态、 *I/O后续处理* 状态等。设备驱动程序在执行过程中，需要对上述状态进行不同的处理

virtio设备进行I/O传输过程中，设备驱动会指出 I/O请求 队列的当前位置状态信息，这样设备能查到I/O请求的信息，并根据 I/O请求 进行I/O传输；而设备会指出 I/O完成 队列的当前位置状态信息，这样设备驱动通过读取 I/O完成 数据结构中的状态信息，就知道设备是否完成I/O请求的相应操作，并进行后续事务处理。

比如，virtio_blk设备驱动发出一个读设备块的I/O请求，并在某确定位置给出这个I/O请求的地址，然后给设备发出’kick’通知(读或写相关I/O寄存器映射的内存地址)，此时处于I/O请求状态；设备在得到通知后，此时处于 I/O处理 状态，它解析个I/O请求，完成个I/O请求的处理，即把磁盘块内容读入到内存中，并给出读出的块数据的内存地址，再通过中断通知设备驱动，此时处于 I/O完成 状态；如果磁盘块读取发生错误，此时处于 I/O错误 状态；设备驱动通过中断处理例程，此时处于 I/O后续处理 状态，设备驱动知道设备已经完成读磁盘块操作，会根据磁盘块数据所在内存地址，把数据传递给文件系统进行进一步处理；如果设备驱动发现磁盘块读错误，则会进行错误恢复相关的后续处理