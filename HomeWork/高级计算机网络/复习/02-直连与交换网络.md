## 二、直连与交换网络

### 1. 直连网络所要解决的问题

信道编码、封装成帧、错误检测、可靠传输、介质访问控制

### 2. 编码

- 曼彻斯特编码: 一个周期的方波表示 "1", 反相波形表示 "0"
- 差分曼彻斯特编码: 相邻周期方波反相表示 "1" ,同相表示 "0"
   - 避免极性反转问题
   - 有固定的首个方波 

优点
   - 码元周期的中间部分存在电平跳变，易于提取时钟，不受信源统计特性的影响
   - 方波周期内，正负电平各一半，不存在直流分量
缺点
   - 频带加倍：比特率为波特率的一半（信号变化的速率为波特率），编码效率仅50%

### 3. 网络适配器

实现大部分数据链路层以及物理层功能
   - 其他数据链路层即之上层数的功能, 由CPU完成

### 4. 组帧

面向字节的组帧
面向比特的组帧


### 5. 差错检测

1. 奇偶校验
   - 单个奇偶校验位
      - 偶校验: 比特信息中, "1" 总数为偶数, 校验位为 "0"
      - 奇校验: 比特信息中, "1" 总数为奇数, 校验位为 "0"
2. 校验和
   - 发送方：把数据分为许多16位字的序列，用反码算数运算将所有16位字相加，对结果取反码，即为校验和
      - 二进制数反码求和（先求和再取反码）：从低位到高位逐列计算，1+1要进位，最高位有进位，回卷到最低位
   - 接收方：将所有16比特字(包括校验和)加一起，结果为全1，认为无差 
3. 循环冗余校验
   - 约定 k 次幂的除数C
     - 实际有 k+1 项, k为最高次幂
   - 消息末尾加上 k 个0
   - 进行非标准多项式除法, 得到 k位 校验码
     - 非标准多项式除法: 异或，不借位 
     - 除数 k+1 位，考虑除法计算与末尾k个0，得到的必然是k位余数   
   - 加上此余数并发送, 接收端除相同除数C，若余数不为0，则判断出错，否则判断无错（并非绝对无错） 

### 6. 可靠传输

#### 6.1 差错检测与可靠传输

- 差错检测只能做到无差错接收
   - 凡是接受的帧（即没有丢弃），我们能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错

- 可靠传输则必须能以某种方式恢复被丢弃或丢失的帧
   - 链路层、传输层、应用层都可提供

#### 6.2 基本机制

可靠传输的基本机制是: 确认 与 超时
- 确认 (ACKnowledgement, ACK)
  - 协议发给它的对等实体的消息，告知它已收到刚才的帧
    - 可以是一个控制帧，即无任何数据的头部
    - 也可以将一个ACK捎带在一个恰好要发向对方的数据帧中
- 超时 (timeout)
  - 发送方收到一个确认，表明帧发送成功；如果在合理的一段时间后未收到确认，那么它重发 (retransmit) 原始帧
  - 等待一段合理时间的这个动作称为超时 (timeout)


#### 6.3 stop-and-wait 算法

基本思想: 发送方传输一帧之后，在传输下一帧之前等待一个ACK；如果在某段时间之后ACK没有到达，则发送方超时，重发原始帧

#### 6.4 sliding-window 算法

发送方
- 维护三个状态变量
  - 发送窗口大小(SWS): 能够发送但为确认的帧数上界
  - 最近被确认过的帧的序号(LAR)
  - 最近发送的帧的序号(LFS)
- 操作
  - 初始时，发送窗口允许的帧, 并更新LFS
  - 收到ACK
    - 更新LAR (右移)，若窗口允许，发送新的帧，更新LFS
    - 为每帧设置定时器，若收到ACK前超时，重传该帧
    - 必须能缓存SWS个帧
 
接收方
- 维护三个状态变量
  - 接收窗口大小(RWS): 能够接受的无序帧数目上界
  - 最大的可接收帧的序号(LAF)
  - 最后确认接收的帧的序号(LFR)
- 操作
  - 收到帧
    - LFR≤SeqNum≤LAF，帧在接收窗口内，接收；否则，丢弃
    - 接受数据帧后，将收到的最大连续数据帧的SeqNum作为ACK回复
      - 此时也应当更新LFR

丢失帧的处理
- 方案一: 回退N机制 (Go-Back-N)恢复丢包
  - 接收方只对连续收到的数据帧回复ACK
  - 发送方，由于接收不到新的ACK，超时后重传LAR+1与LFS之间的数据帧
- 方案二: 择确认机制 (Selective Acknowledgments) 恢复丢包 
  - 接收方准确地确认每个已接受的数据帧，发送方根据这些信息更快重传 
  - 传输效率更高，但实现更复杂(意味着每接收一个，都需要发送确认)

有限序号大小
- SWS=RWS时
  - SWS+RWS < MaxSeqNum  (MaxSeqNum=2^n，n为序列号使用的比特数)
  - 即 SWS=RWS<2^n−1
  - 发送窗口大小不能大于可用序列号数的一半


#### 6.5 媒体共享

#### 6.6 以太网帧结构

**以太网接收数据的方式**
- 以太网适配器接收(receive)所有帧
  - 广播信道，所有主机在一个广播域
- 但以太网适配器只接受(accept)
  - 编址到它自己地址的帧
  - 编址到广播地址的帧
  - 编址到多点播送地址的帧，如果适配器在监听那个地址
  - 所有帧，如果适配器处于混杂模式
- 以太网适配器只向主机传递它接受的帧

**以太网不提供可靠传输**
基于MAC的以太网协议并不提供可靠传输, 需要与上述概念区分

- 提供的服务是尽最大努力的交付，即不可靠的交付
  - 对发送的数据帧不进行编号，也不要求对方发回确认
  - 当目的站收到有差错的数据帧时丢弃，差错的纠正由高层决定
  - 如果高层进行重传，以太网并不知道这是重传帧，当作新的帧发送
- 无效帧
  - 帧的长度不是整数个字节
  - 用收到的帧检验序列 CRC查出有差错
  - 数据字段的长度不在 46 ~ 1500 字节之间
    - 有效的 MAC 帧长度为 64 ~ 1518 字节之间


#### 6.7 交换网络






