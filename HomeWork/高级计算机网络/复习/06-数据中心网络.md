## 六、数据中心网络

- [六、数据中心网络](#六数据中心网络)
  - [1. 数据中心网络定义](#1-数据中心网络定义)
  - [2. DC内部](#2-dc内部)
    - [2.1 数据中心网络拓扑设计目标](#21-数据中心网络拓扑设计目标)
    - [2.2 拓扑结构](#22-拓扑结构)
      - [2.2.1 Fat-Tree数据中心网络](#221-fat-tree数据中心网络)
        - [(1) 定义](#1-定义)
        - [(2) 拓扑](#2-拓扑)
        - [(3) 特性](#3-特性)
        - [(4) IP地址分配与路由](#4-ip地址分配与路由)
        - [(5) 小结](#5-小结)
      - [2.2.2 Virtual Layer 2](#222-virtual-layer-2)
        - [(1) 设计目的](#1-设计目的)
        - [(2) 设计方法](#2-设计方法)
        - [(3) 小结](#3-小结)
    - [2.3 传输控制协议](#23-传输控制协议)
      - [2.3.1 TCP Incast](#231-tcp-incast)
      - [2.3.2 DCTCP](#232-dctcp)
        - [(1) 使用ECN](#1-使用ecn)
        - [(2) 小结](#2-小结)
      - [2.3.3 Swift](#233-swift)
        - [(1) 基于时延的拥塞控制](#1-基于时延的拥塞控制)
        - [(2) Swift设计](#2-swift设计)
      - [(3) 小结](#3-小结-1)
    - [2.4 测量与故障定位](#24-测量与故障定位)
      - [2.4.1 Pingmesh](#241-pingmesh)
        - [(1) 小结](#1-小结)
  - [3. DC之间](#3-dc之间)
    - [3.1 SWAN](#31-swan)

### 1. 数据中心网络定义

DC: Data Center
   - 由成千上万台服务器、交换机组成, 进行计算与存储业务

数据中心网络与普通互联网存在较大差异: 结构、协议等

Pod: 理解为一个机架, 包括数台交换机与服务器

### 2. DC内部

#### 2.1 数据中心网络拓扑设计目标

总体目标：敏捷性（Agility） 
   - 业务可以部署在任意的服务器上
   - 根据需要动态扩展或者缩小服务器规模

网络角度
   - 均匀的负载、且高性能：服务器之间的性能仅受限于服务器网卡，而不是链路
   - 性能隔离：一个业务的流量不影响其他业务的性能
   - 易于管理：服务器配置简单等

#### 2.2 拓扑结构

##### 2.2.1 Fat-Tree数据中心网络

###### (1) 定义

Fat-Tree
   - 基于Fat-tree拓扑结构（Clos网络的一种）
      - Clos网络：通过多级互联实现任意两个节点（服务器）之间的无阻塞通信
   - 各层使用相同的交换机
   - 引入新的地址和路由算法，实现负载的均衡

###### (2) 拓扑

- k个pod, 使用相同类型的k个端口的交换机
- 一个pod中
   - 两层交换机, 每层 $\frac{k}{2}$ 个交换机
      - 上层称为汇集交换机, 下层称为边缘交换机 
   - 每个pod中, 有 $\left(\frac{k}{2}\right)^{2}$ 台服务器, 因此总共有 $\frac{k^{3}}{4}$ 台服务器
- 边缘交换机
   - 向下连接 $\frac{k}{2}$ 台服务器(总和就是 $\left(\frac{k}{2}\right)^{2}$ 台服务器)
      - 可以按照顺序，依次连接服务器，一台交换机满足 $\frac{k}{2}$ 个连接后，下一台交换机继续，不重复进行连接
   - 向上连接 $\frac{k}{2}$ 台汇聚交换机(即连接每台汇聚交换机) 
- 汇聚交换机
   - 向下连接 $\frac{k}{2}$ 台边缘交换机(即连接每台边缘交换机)
   - 向上连接 $\frac{k}{2}$ 台核心交换机
- 核心交换机
   - 有 $\left(\frac{k}{2}\right)^{2}$ 台核心交换机
   - 每个交换机第i个端口连接第i个pod 
      - 具体连接路由器的方式可以参考 边缘交换机与服务器的连接 

![fat-tree]()

###### (3) 特性

- 拓扑特性
  - 每一层的累计带宽相同（1:1）
- 所有交换机都一样，核心也无需高速率端口的交换机：能耗低
  - 端口的速率与服务器端口速率相同
  -  如果数据包是均匀的分布在可用的路径上，那么所有服务器都可以以线速发送数据包
- 扩展性高：k端口交换机，支持 $\frac{k^{3}}{4}$ 服务器
  - 24端口千兆交换机：3456个服务器

###### (4) IP地址分配与路由

**IP地址分配**

- Pod交换机：10.pod.switch.1
  - 同一个 pod 中 switch 自下层自右依次编号 
- 核⼼交换机：10.k.j.i，j, i取值 [1, $\frac{k}{2}$]
  - k即pod数量 
- 服务器：10.pod.switch.ID, ID取值 [2, $\frac{k}{2}$ + 1]

**路由**

- 两级路由
  - 第一级是前缀路由(和IP网络一样），用来向下路由到服务器
  - 第二级是后缀路由，用来向核心交换机方向转发数据

###### (5) 小结

- 通过定制化的设计和Clos网络结构，比传统基于树的结构具有良好的扩展性，而且无需高端交换机
- 不足
  - 不支持服务的动态迁移
  - 定制化的路由


##### 2.2.2 Virtual Layer 2

###### (1) 设计目的

- 高吞吐：任意服务器之间的吞吐仅受限于服务器网卡，而不是网
络
- 性能隔离：一个服务（如搜索）流量与另一个服务（如视频）流
量相互隔离
- 2层语义：任意服务可运行在任意服务器，而不需要改变IP地址
（通常服务与IP绑定）

###### (2) 设计方法

- 使用随机理念适应流量的不稳定
- 建立在现有的网路技术之上（与Fat-Tree增加后缀路由的区别）
- 虚拟服务器身份（与服务绑定）和位置（与拓扑相关）分离
- 端系统改（增加agent）

###### (3) 小结

- 数据驱动，使用已有的技术，实现可扩展、敏捷的数据中心网络
- 不足：
  - 目录服务器的引入是否会成为瓶颈？
  - 为了实现VLB，所有链路、所有交换机一直在线，能耗高
  - 论文发稿时，仅在实验室环境验证

#### 2.3 传输控制协议

##### 2.3.1 TCP Incast

问题描述
- 交换机buffer一般较小，多个接口共享
- Incast：多个向一个发送，导致交换机出端口队列占满

解决方案
- 增大交换机的buffer
  - 成本高
  - 长流短流混合后，短流latency会增大
- 减小RTO
  - 伪重传增加
  - 更多的slow start
- EFC：以太网流控
  - Head-of-line阻塞
  - 实现存在困难
- 人为增加随机delay
  - 尾部时延降低，但整体时延增大

##### 2.3.2 DCTCP

Data Center TCP

###### (1) 使用ECN

交换机
- 队列 > k，标记数据包，标记由receiver返回


###### (2) 小结

- 端系统 + 交换机共同修改
- 能够解决早期数据中心面临的传输效率问题
- 潜在问题
  - 参数调整：尽管给出了计算公式，但比较粗粒度，实际中需要调整
  - Incast问题还是有：当并发流数目很多的时候
  - 会产生丢包

##### 2.3.3 Swift

###### (1) 基于时延的拥塞控制

基于硬时间戳的网络时延测量

###### (2) Swift设计

- 维护两个窗口：一个对应网络拥塞，一个对应端系统拥塞 • 端系统的时延测量：edelay = remote queueing + t_6 - t_5
- 网络时延：ndelay = RTT – edelay
- 两个窗口分别用基于时延的cc调整，取最小值作为发送窗口


##### (3) 小结

- 经过长期验证的、基于时延的数据中心网络拥塞控制机制
- 网络与端系统两部分时延分开考虑
  - 考虑端系统拥塞，可降低2倍的尾部时延
- 需要硬件网卡支持时间戳


#### 2.4 测量与故障定位

##### 2.4.1 Pingmesh

###### (1) 小结

- always-on & 全网网络时延
- 发表时已经在微软应用4年
- 国内很多企业也在用类似思想
- 简单，好用

### 3. DC之间

#### 3.1 SWAN

