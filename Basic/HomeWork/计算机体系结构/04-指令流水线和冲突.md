# 指令和流水线冲突

## 基本概念

- 时钟周期:
  - 一个时钟脉冲所需要的时间
  - CPU和其他单片机的基本时间单位, 一个时钟周期内，CPU仅完成一个最基本的动作
- 总线周期:
- 机器周期:
  - 通常用从内存中读取一个指令字的最短时间来规定CPU周期
    - 也即CPU完成一个基本操作所需的时间
  - 多个时钟周期
    - 通常一个机器周期包含12个时钟周期
  - 理解，CPU的实现依靠时序电路，而完成一个指令的各工作周期，都是由一些小步骤组成，而这些小步骤，通过时序电路产生的周期信号实现
- 指令周期:
  - 执行一条指令所需要的时间
  - 多个机器周期
  - 显然，取指译码、间址、执行、中断，一般都是一个机器周期

- [各种周期](https://blog.csdn.net/yelin042/article/details/80878832)



- 流水线
  - 核心价值: 理想情况下，流水线能够实现n倍的吞吐量加速比
    - n为流水线深度
  - 核心问题: 指令直接的依赖关系
    - 指令之间存在数据依赖、控制依赖

## RISC指令集

- RISC: Reduced Instruction Set Computer
  - 数据操作都依赖于寄存器，并且通常会改变寄存器值
  - 只有LOAD与STORE指令会影响到内存，将数据从内存传送至寄存器，或者从寄存器传送数据到内存
  - 指令格式的数量少，并且指令的长度一般相同

- RISC三类指令
  - ALU指令
    - 对两个寄存器操作数（或一个寄存器操作数和一个立即数操作数）进行特定运算，并将结果存入第三个寄存器
  - Load/Store指令
    - 将特定内存位置的数值读入特定寄存器，或将特定寄存器的内容存入特定内存位置
    - 内存位置由一个基址寄存器和一个立即数偏移量指定
  - Branches和Jumps指令
    - 跳转条件通常由两个寄存器的比较结果指定（或一个寄存器同0值的比较结果
    - 目的地址由一个相对于当前PC的偏移量指定

## 指令周期

- RISC指令周期
  - 每条指令最多执行5个周期
    - IF: Instruction Fetch
      - 从存储器读来指令，并准备下一条指令
        - 发送PC至内存，并使得 PC = PC + 4 (32位指令)
    - ID: Instruction Decode/Register Fetch
      - 指令译码，读寄存器堆为ALU准备数据
        - 根据源操作数标识符，从寄存器堆中读取出源操作数
        - 对读取的源操作数进行比较，以为可能的跳转做准备
        - 对指令中的偏移量进行符号扩展
        - 计算可能的跳转目的地址
    - EX: Execution/Effective Address
        - ALU执行数据运算，或计算存储器地址
          - 访存指令: 将基址寄存器和偏移量相加形成访存地址
          - 寄存器-寄存器运算指令: 对读取的2个源操作数执行指定操作
          - 寄存器-立即数运算指令: 对读取的第一个源操作数和立即数执行指定的操作
    - MEM: Memory Access
      - 完成存储器的读或写操作
        - Load: 使用前一个周期计算得到的访存地址读取内存
        - Store: 将数据写入由前一个周期计算得到的访存地址
        - 阶段完成后，数据只是暂存在相应部件中，还需要进一步写入寄存器堆
    - WB: Write Back
      - 写ALU的结果或存储器读出的数据到寄存器堆
        - 对于寄存器-寄存器运算指令和LOAD指令: 将结果写入寄存器文件

## 流水线

- 在每一个指令阶段启动一条新的指令，就能够实现流水化

