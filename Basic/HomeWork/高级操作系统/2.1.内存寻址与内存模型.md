# 内存寻址与内存模型


## 一、 内存模型

- 内存从0开始按字节编址，地址小为低地址，地址大为高地址
- 一般而言，系统代码(OS)在低地址区，用户代码在高地址区

## 二、虚拟地址空间

- 虚拟地址同样从0开始按字节编址
- 虚拟地址空间可分为3个部分
  - 代码段: 存储需要执行的程序指令
    - 位于低地址
  - 数据段:
    - 位于低地址 
    - 分为 只读数据段、已初始化的读写数据段、未初始化段
      - 只读数据段: 存放不会更改的数据，如常量
      - 已初始化的读写数据段: 有初值的变量，如已经初始化的全局变量、静态局部变量
      - 未初始化段: 程序中声明，但没有初始化的变量, 如没有初始化的全局变量、静态局部变量
  - 堆段: 由用户分配，且需要手动释放
    - 从低地址向高地址增长
  - 栈段: 由编译器自动分配与释放，存放函数的参数值、局部变量等值
    - 从高地址向低地址增长

- 通过 基址 与 界限 能够映射一段虚拟地址到物理地址
- 通过方向 能够区分 堆 与 栈

![基址、界限、方向、保护](./img/2022-03-12-08-55-45.png)

### NUMA

- Non-Uniform Memory Architecture 非一致性内存访问架构

**节点 Nodes**

- 在NUMA模型中，系统的物理内存被划分为几个节点(Nodes), 在一个单独的节点内，任意一个CPU访问页面所需的时间都是一样的

**管理区 Zones**

- 每个节点被划分为多个管理区，每个管理区的地址范围不一样
  - ZONE_DMA: 包含的页能够用来执行DMA操作
  - ZONE_NORMAL: 包含的页都是能够正常映射的也
  - ZONE_HIGHEM: 包含"高端内存"，其中的页不能永久地映射到内核地址空间

![NUMA_ZONES](./img/2022-03-12-09-34-57.png)

**物理页**

- 每个管理区再进一步被划分为许多4K大小的物理页

![相互关系](./img/2022-03-12-09-36-34.png)

- 管理区水印
  - 管理区包含三个水印: pages_min、pages_low、pages_high
  - 三个水印相当于三个阈值，由于触发 kswapd 进程以及相应的物理页释放策略

## 三、寻址过程

- x86架构地址类型
  - 逻辑地址
    - 机器语言指令中，用来指定一个操作数或者是一条指令的地址, 每个逻辑地址由一个段和偏移量组成，偏移量指明了从段开始的地方到实际地址之间的距离
  - 线性地址
    - 即是虚拟地址
  - 物理地址
    - 即是物理地址

### 逻辑地址转换

- MMU通过 分段单元硬件电路 把一个逻辑地址转换成线性地址
- MMU通过 分页单元硬件电路 把线性地址转换成一个物理地址
- 逻辑地址 -> 分段单元 -> 线性地址 -> 分页单元 -> 物理地址

**分段寻址**

- CPU支持不同的方式来进行地址转换
  - 实模式
  - 保护模式

- 实模式分段寻址
  - 程序可以有多个独立的地址空间，叫做段，一个程序可以分别把它的指令和数据保存在指令段和数据段中
