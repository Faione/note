# 嵌套虚拟化实验报告

<p align="right">学号: 2021E8013282148</p>
<p align="right">姓名: 方浩镭</p>

- [嵌套虚拟化实验报告](#嵌套虚拟化实验报告)
  - [一、实验要求](#一实验要求)
  - [二、实验过程](#二实验过程)
  - [三、实验结果](#三实验结果)
    - [(1) 嵌套虚拟化benchmark分析](#1-嵌套虚拟化benchmark分析)
    - [(2) 嵌套虚拟机与宿主虚拟机性能比较](#2-嵌套虚拟机与宿主虚拟机性能比较)
    - [(3) 不同配置的嵌套虚拟机性能比较](#3-不同配置的嵌套虚拟机性能比较)

## 一、实验要求

- 分析嵌套虚拟化的benchmark
- 对比分析嵌套虚拟机和宿主机的benchmark测试结果
- 分析不同配置的CPU和内存虚拟机的unixbench
## 二、实验过程

分别在宿主虚拟机与嵌套虚拟机上运行benchmark, 并测试不同配置下的嵌套虚拟机得分，汇总得到如下实验结果

| | CPU | Mem | 得分1 | 用时(min:s) | 得分2 | 用时(min:s) | 
| - | :-: | :-: | :-: | :-: | :-: | :-: |
| 宿主虚拟机 | 4 | 8192 | 976.8 | 28:27 | 2626.5 | 28:31 |
| 嵌套虚拟机 | 1 | 1024 | 1209.4 | 28:03 | - | - |
| 嵌套虚拟机 | 2 | 2048 | 1091.8 | 28:03 | 1957.7 | 28:04 |
| 嵌套虚拟机 | 4 | 4096 | 1102.5 | 28:06 | 3010.3 | 28:06 |
| 嵌套虚拟机 | 4 | 8192 | 1074.9 | 28:09 | 2799.0 | 28:08 |
| 嵌套虚拟机 | 8 | 8192 | 1041.2 | 28:05 | 2199.8 | 28:03 |

## 三、实验结果

### (1) 嵌套虚拟化benchmark分析

实验中使用的 Byte Unix Benchmarks 进行嵌套虚拟化虚拟机的性能评估, 其本身有多个测试项目组成，分别是

1. Dhrystone测试
  - 测试聚焦在字符串处理，没有浮点运算操作
  - 这个测试用于测试链接器编译、代码优化、内存缓存、等待状态、整数数据类型等，硬件和软件设计都会非常大的影响测试结果
2. Whetstone 测试
  - 这项测试项目用于测试浮点运算效率和速度
  - 这项测试项目包含若干个科学计算的典型性能模块，包含大量的C语言函数,sin cos sqrt exp和日志以及使用整数和浮点的数学操作
  - 包含数组访问、条件分支和过程调用
3. Execl Throughput测试
   - 这项测试测试每秒execl函数调用次数
   - execl是 exec函数家族的一部分，使用新的图形处理代替当前的图形处理
   - 有许多命令和前端的execve()函数命令非常相似
4. File Copy测试
   - 这项测试衡量文件数据从一个文件被传输到另外一个，使用大量的缓存
   - 包括文件的读、写、复制测试，测试指标是一定时间内（默认是10秒）被重写、读、复制的字符数量
5. Pipe Throughput（管道吞吐）测试
   - pipe是简单的进程之间的通讯
   - 管道吞吐测试是测试在一秒钟一个进程写512比特到一个管道中并且读回来的次数
   - 管道吞吐测试和实际编程有差距
6. Pipe-based Context Switching （基于管道的上下文交互）测试
   - 这项测试衡量两个进程通过管道交换和整数倍的增加吞吐的次数
   - 基于管道的上下文切换和真实程序很类似
   - 测试程序产生一个双向管道通讯的子线程。
7. Process Creation(进程创建)测试
   - 这项测试衡量一个进程能产生子线程并且立即退出的次数
   - 新进程真的创建进程阻塞和内存占用，所以测试程序直接使用内存带宽
   - 这项测试用于典型的比较大量的操作系统进程创建操作
8. Shell Scripts测试
   - shell脚本测试用于衡量在一分钟内，一个进程可以启动并停止shell脚本的次数
   - 通常会测试1，2， 3， 4， 8 个shell脚本的共同拷贝
   - shell脚本是一套转化数据文件的脚本
9. System Call Overhead （系统调用消耗）测试
   - 这项测试衡量进入和离开系统内核的消耗，例如，系统调用的消耗
   - 程序简单重复的执行getpid调用（返回调用的进程id）
   - 耗的指标是调用进入和离开内核的执行时间

### (2) 嵌套虚拟机与宿主虚拟机性能比较

使用与宿主虚拟机相同的CPU与MEM配置构造嵌套虚拟机进行benchmark
1. 从总跑分上来看，嵌套虚拟机相比与宿主虚拟机得分更高, 在单并行度与多并行度上的性能差异分别为9.12%与6.16%
2. 在12项测试之中, 嵌套虚拟机有7项高于宿主虚拟机, 6项低于宿主虚拟机, 其中 "Execl Throughput"、"Shell Scripts (8 concurrent)"得分远高于宿主虚拟机，而这两个测试都与操作系统相关
3. 因此，得分上的差异可能由于宿主机系统与嵌套虚拟机系统差异导致，因为UnixBench测试结果不仅仅取决于硬件，也取决于系统、开发库、甚至是编译器，但是总体可以得到结论，嵌套虚拟化几乎不会带来性能损失

**表1: 嵌套虚拟机与宿主虚拟机配置与得分**
| | CPU | Mem | 得分1 | 用时(min:s) | 得分2 | 用时(min:s) | 
| - | :-: | :-: | :-: | :-: | :-: | :-: |
| 嵌套虚拟机 | 4 | 8192 | 1074.9 | 28:09 | 2799.0 | 28:08 |
| 宿主虚拟机 | 4 | 8192 | 976.8 | 28:27 | 2626.5 | 28:31 |
<p align="right">得分1: 单并行度得分 得分2: 多并行度得分</p>  

**表2: 嵌套虚拟机与宿主虚拟机各项得分比较**
| System Benchmarks Index Values  | RESULT | INDEX | BASELINE | RESULT | INDEX |
| - | - | - | :-: | - | - |
| Dhrystone 2 using register variables | 25154924.1 | 2155.5(-) | 116700.0 | 34053298.8  | 2918.0 |
| Double-Precision Whetstone  | 5398.8 | 981.6(-) | 55.0   | 5806.4 | 1055.7 |
| Execl Throughput | 7800.3 | 1814.0(+) | 43.0  | 2867.6 | 666.9 |
| File Copy 1024 bufsize 2000 maxblocks  | 632648.1 | 1597.6(+) | 3960.0 | 534399.9 | 1349.5 |
| File Copy 256 bufsize 500 maxblock | 162613.1 | 982.6(+) | 1655.0 | 138947.1 | 839.6 |
| File Copy 4096 bufsize 8000 maxblocks | 1855106.8  | 3198.5(+) | 5800.0 | 1748545.7 | 3014.7 |
| Pipe Throughput | 839848.2 | 675.1(+) | 12440.0 | 704975.9 | 566.7 |
| Pipe-based Context Switching | 78876.6 | 197.2(-) | 4000.0 | 104907.9 | 262.3 |
| Process Creation | 4202.2 | 333.5(-) | 126.0 | 7063.7  | 560.6 |
| Shell Scripts (1 concurrent) | 6070.5 | 1431.7(-) | 42.4 | 7044.0 | 1661.3 |
| Shell Scripts (8 concurrent)  | 2680.1 | 4466.8(+) | 6.0 | 1659.5 | 2765.8 |
| System Call Overhead | 651979.9 | 434.7(+) | 15000.0 |  421055.0 | 280.7 |
<p align="right">左: 嵌套虚拟机 右: 宿主虚拟机, "+"表示得分更高, "-"则表示得分更低</p>  

### (3) 不同配置的嵌套虚拟机性能比较

对比不同配置下的嵌套虚拟机性能, 可以得到如下结果
- 增加虚拟机的CPU与MEM, 对于单并行度得分影响不大
  - 在单并行度测试中, 因为仅有一个线程运行, 所以即便分配更多的CPU, 也对结果不会有太大影响
- 增加虚拟机的CPU与MEM, 能够对多并行度得分产生影响，前提是配置需要在宿主虚拟机的范围之类
  - 图1中 CPU 为 1、2、4 的多并行度得分明显增加, 受制于RAM磁盘大小，cache等其他硬件因素, 得分的增加并非是完全线性的
  - 宿主虚拟机CPU个数为4, 当分配 CPU 为 8 时, 进行多并行度测试时由于CPU之间的竞争与抢占, 得分反而更低

![得分对照图](./images/record.png)
<center>图1: 不同配置嵌套虚拟机得分</center>
