# 一、重构目标

|目标|具体|描述|
|:-:|:-:|:-:|
|功能拓展|接入类型拓展|接入k8s集群、ray集群等|
||控制维度拓展|增加可控资源，拓展控制方式|
|性能优化|运行效率|优化协程数量，运行模式，降低开销|
||稳定性|完善运行、退出机制|
||实时性|提升响应速度，实现毫秒级控制|

# 二、架构设计图

![](http://152.136.134.100:10047/server/index.php?s=/api/attachment/visitFile&sign=f2b46a525d55e63f0a5d5660294bd19a)


# 三、模块关系图

```plantuml
@startuml
skinparam rectangle<<behavior>> {
	roundCorner 25
}

sprite $supbService jar:archimate/application-service
sprite $supbServiceBusiness jar:archimate/business-service
sprite $supbData jar:archimate/application-data-object

rectangle "api server" as api_server <<$supbService>><<behavior>> #Application
rectangle "Bus In" as BI <<$supbServiceBusiness>><<behavior>> #Business
rectangle "Bus Out" as BO <<$supbServiceBusiness>><<behavior>> #Business

rectangle "manager api" as manager_api <<$supbService>><<behavior>> #Application

rectangle "Engine" as Engine <<$supbService>><<behavior>> #Application {
 rectangle "manager" as manager <<$supbService>><<behavior>> #Application
 rectangle "controller" as controller <<$supbService>><<behavior>> #Application
 rectangle "collector" as collector <<$supbService>><<behavior>> #Application
 rectangle "heartbeat" as heartbeat <<$supbService>><<behavior>> #Application
}

rectangle "rpc client" as rpc_client <<$supbService>><<behavior>> #Application

rectangle "common sdk" as common_sdk <<$supbService>><<behavior>> #Application

rectangle "informer" as informer <<$supbService>><<behavior>> #Application


BI -down-* api_server
api_server -down-* manager_api
manager_api -down-* manager

controller *-down-* informer
manager *-down-* informer
collector *-down-* informer
heartbeat *-down-* informer

rpc_client -down-* BO
manager *-down-* rpc_client
collector -down-* rpc_client
heartbeat -down-* rpc_client

collector -down-* common_sdk
controller -down-* common_sdk
heartbeat -down-* common_sdk

legend left
note
====
<$supbService> : module-internel
====
<$supbServiceBusiness> : module-externel
endlegend
@enduml
```

# 四、事件流

TODO：1. 增加 事件完毕 事件 2. 对象描述 直接调用 manager（informer挂钩子）3. api 调用补充返回

## (1) 说明

|**事件**|**说明**|
|:-:|:-:|
|对象创建|创建对象接入到系统中|
|对象删除|删除对象并回收资源|
|对象更新|更新对象状态与资源分配|
|对象描述|获得对象的状态、资源描述|
|对象监控|上报对象的监控数据|

## (2) 对象创建

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true

participant BusIn as f1
participant ApiServer as f2
participant InFormer as f3
participant Manager as f4
participant RpcClient as f5
participant Controller as f6
participant Collector as f7
participant CommonSDK as f8


f1    ->     f2  :创建请求
f2    ->     f3  :产生"对象创建"事件
f3    ->     f4  :消费"对象创建"事件
f4    ->     f4  :重复创建检查
f4    ->     f5  :请求GUID
f5   -->     f4  :返回GUID
f3    ->     f6  :消费"对象创建"事件
f6    ->     f8  :调用底层SDK进行创建
f8   -->     f6  :返回创建成功的信息
f6   -->     f3  :发布"对象更新"事件
f3   -->     f4  :消费"对象更新"事件
f4    ->     f5  :创建对象的api server
f4    ->     f7  :创建收集器
f7    ->     f8  :收集数据
f8    -->    f7  :返回数据
@enduml
```

## (3) 删除对象

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true

participant BusIn as f1
participant ApiServer as f2
participant InFormer as f3
participant Manager as f4
participant RpcClient as f5
participant GC as f6
participant CommonSDK as f7


f1    ->     f2  :创建请求
f2    ->     f3  :产生"对象删除"事件
f2   -->     f1  :返回操作完成
f3    ->     f4  :消费"对象删除"事件
f4    ->     f4  :存在检查, 更新对象状态
f4    ->     f5  :终止对象的api server
f4    ->     f5  :注销guid
f3    ->     f6  :消费"对象删除"事件
f6    ->     f7  :调用底层SDK进行删除
f7   -->     f6  :返回删除成功的信息
f6   -->     f3  :发布"对象更新"事件
f3    ->     f4  :消费"对象更新"事件
f4    ->     f4  :收尾工作，删除对象的信息
@enduml
```

## (4) 更新对象

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true

participant BusIn as f1
participant ApiServer as f2
participant InFormer as f3
participant Manager as f4
participant RpcClient as f5
participant Controller as f6
participant CommonSDK as f7


f1    ->     f2  :创建请求
f2    ->     f3  :产生"对象更新"事件
f2   -->     f1  :返回操作完成
f3    ->     f4  :消费"对象更新"事件
f4    ->     f4  :存在检查, 更新对象状态
f3    ->     f6  :消费"对象更新"事件
f6    ->     f7  :调用底层SDK进行更新
f7   -->     f6  :返回更新成功的信息

@enduml
```

## (5) 描述对象

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true

participant BusIn as f1
participant ApiServer as f2
participant InFormer as f3
participant Manager as f4


f1    ->     f2  :创建请求
f2    ->     f3  :产生"对象描述"事件
f2   -->     f1  :返回操作完成
f3    ->     f4  :消费"对象描述"事件
f4    ->     f4  :存在检查
f4    ->     f2  :返回对象信息

@enduml
```

## (6) 心跳检查

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true


participant HeartBeat as f1
participant InFormer as f2
participant Manager as f3

participant RpcClient as f4

participant GC as f5
participant CommonSDK as f6


f1    ->     f3  :读取已有对象状态、资源情况
f1    ->     f1  :超时启动检查
f1    ->     f5  :上报对象状态、资源情况
f1    ->     f2  :根据超时检查结果，发布"对象删除"事件
f2    ->     f3  :消费"对象删除"事件, 更新对象状态
f3    ->     f4  :终止对象的api server
f3    ->     f4  :注销guid
f2    ->     f5  :消费"对象删除"事件
f5    ->     f6  :调用底层SDK进行删除
f6   -->     f5  :返回删除成功的信息
f5   -->     f2  :发布"对象更新"事件
f2    ->     f3  :消费"对象更新"事件
f3    ->     f3  :删除状态为终止的对象的信息

@enduml
```

## (7) 监控对象

metric监控、log监控、trace监控

```plantuml
@startuml
skinparam roundCorner 25
skinparam responseMessageBelowArrow true

participant BusIn as f1
participant ApiServer as f2
participant InFormer as f3
participant Collector as f4
participant RpcClient as f5


f1    ->     f2  :监控请求
f2    ->     f3  :产生"对象监控"事件
f3    ->     f4  :消费"对象监控"事件
f4    ->     f4  :存在检查
f4    ->     f5  :将监控数据写入指定topic
@enduml
```

# 五、API设计

# 六、规范设计

# 七、流程设计
