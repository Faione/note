# 3月

## Server Exporter

a) 参考Node Exporter设计Exporter框架，在原有Node Exporter触发式的同步采集的基础上，增加异步采集的方案，本身由与prometheus对接的同步采集部分与后台更新数据的异步采集部分组成，扩充了Exporter的采集语义，能够支持如日志处理等特殊情况

b) hardwareinfo, 通过 go sysinfo 库实现对硬件基本信息的采集，包括CPU、网卡、硬盘、内存、系统等常用信息，提供一台服务器的基础描述信息，这部分数据均通过label附加在指标上，指标值并没有意义

c) 端口连接统计，通过 go netstat 库来对进程打开的端口进行解析，实质是读取 /proc/pid/net/tcp 和 /proc/pid/net/udp 文件并进行解析。考虑到需要对所有进程进行遍历，读取文件需要大量的IO, 因此使用两个协程进行处理以优化读取过程

d) 登录用户统计，linux中会将当前登录的用户的信息保存在 `/var/run/utmp` 文件中，本身是C结构体，可以通过 `w`, `who` 等命令行工具进行读取，server exporter 中通过 Cgo 调用对文件进行解析，获得登录用户的信息，并转化为指标进行暴露

e) auth log, linux当前登录用户信息中仅包含用户登录后运行的命令，但并不知道用户是通过密码还是密钥进行登录，而 auth log 中记录了用户每次登录的SSH编号以及相应的认证信息, 通解析日志可以知道用户登录所使用的方式。而为减少采集开销，使用异步采集，后台运行一个协程，持续追踪日志文件并生成指标，前台采集则直接获取最新的指标内容进行暴露

d) container数量统计，容器数量通过docker client获得

## Perf Event Exporter

a) 使用逻辑优化, 上一个版本中采集程序与perf分离，采用shell脚本和日志文件进行连接，这种方式不够稳定，同时随着采集时间的增加，日志文件也会越来越大，而这个版本中则采用单进程的方式，以参数的形式将任意perf命令传入到采集程序中，采集程序中会对命令进行一定处理然后再运行，同时使用具名pipe代替日志文件，实现数据同步

d) 同时支持 server mode 和 client mode，上一个版本中，采集程序仅支持client mode，既每次采集到perf event之后，固定向push gateway推送，而在这个版本中，考虑到目标应用除短暂运行的作业以外，还包括持续运行的服务，此时并没有必要使用 push gateway，因此exporter还提供了server mode，可以直接作为exporter被prometheus采集


## 分享
    
a) prometheus client go 调研，主要调研client库中与构造exporter相关的使用方法，分析不同Metric之间的差异与使用场景，同时调研了client内部如何实现不同的Metric，以及采集时进行并发控制的方法

