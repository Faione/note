# 可观测性方案

- [可观测性方案](#可观测性方案)
  - [一、容器](#一容器)
    - [(1) Metric](#1-metric)
      - [应用接入](#应用接入)
      - [流程设计](#流程设计)
    - [(2) Log](#2-log)
      - [应用接入](#应用接入-1)
      - [流程设计](#流程设计-1)
    - [(3) Trace](#3-trace)
      - [应用接入](#应用接入-2)
      - [流程设计](#流程设计-2)
  - [二、集群](#二集群)
    - [(1) Metric](#1-metric-1)
      - [应用接入](#应用接入-3)
      - [流程设计](#流程设计-3)
    - [(2) Log](#2-log-1)
      - [应用接入](#应用接入-4)
      - [流程设计](#流程设计-4)
    - [(3) Trace](#3-trace-1)
      - [应用接入](#应用接入-5)
      - [流程设计](#流程设计-5)
    - [实现](#实现)

## 一、容器

### (1) Metric

#### 应用接入

#### 流程设计

### (2) Log

#### 应用接入

#### 流程设计

### (3) Trace

#### 应用接入

#### 流程设计

## 二、集群


### (1) Metric

| 依赖项目        | 项目类型 | 功能需求 |
| --------------- | -------- | -------- |
| kube-prometheus | k8s yaml | kubectl  |

#### 应用接入


#### 流程设计

- 前提
  - 下载配置文件
    - `git clone https://github.com/prometheus-operator/kube-prometheus.git`

- 准备
  - 在 `prometheus-prometheus.yaml` 中加入remote配置

```yml
# `192.168.49.2:10000/write`接口由agent提供
remoteWrite:
- url: "http://192.168.49.2:10000/write"
```

- 控制
  - 通过 k8s driver 安装yaml文件
  - agent 接收 prometheus remote write
  - agent 提供 Metric RPC
    - 控制是否进行转发
    - 设置转发的目标

**流程图**

### (2) Log

| 依赖项目 | 项目类型 | 功能需求    |
| -------- | -------- | ----------- |
| vector   | helm     | helm driver |

#### 应用接入

#### 流程设计

- 前提
  - 私有Helm Repo中准备vector chart

- 准备
  - 通过 values 配置 vector 输出方式为nats
  - 配置nats topic默认为总控

- 控制
  - agent 提供 LogPush RPC
  - agent 通过 helm driver 控制release启动、停止来控制LogPush
    - 默认开启LogPush

**流程图**


### (3) Trace

| 依赖项目 | 项目类型 | 功能需求   |
| -------- | -------- | ---------- |
| jaeger   | k8s yaml | k8s driver |

#### 应用接入

#### 流程设计

**流程图**

### 实现

| 依赖项目        | 项目类型 | 功能需求    | 可控性 |
| --------------- | -------- | ----------- | ------ |
| kube-prometheus | k8s yaml | kubectl     | 完全   |
| vector          | helm     | helm driver | 部分   |
| jaeger          | k8s yaml | k8s driver  | 暂定   |